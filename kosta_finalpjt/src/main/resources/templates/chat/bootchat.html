<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>채팅방</title>
</head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/chat/chatdesign.css}">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/sockjs/1.0.1/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/common/reset.css}">
    <link rel="stylesheet" th:href="@{/css/common/leftnav.css}">
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
<script th:inline="javascript">
        var stompClient = null;
        var roomId = null;
        var userId1 = [[${userId1}]];

        function connect(newRoomId) {
        	roomId = newRoomId;
            var socket = new SockJS('/auth/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                var subscriptionId = 'sub-' + userId1;
                
                stompClient.subscribe('/room/' + roomId, function(messageOutput) {
                    showMessage(JSON.parse(messageOutput.body));
                }, { id: subscriptionId });
                loadMessages(roomId);	  
                loadChatRoomsConnect(roomId, userId1);             
            });
            var exitChatRoomLink = document.getElementById('getOutRoom');
            exitChatRoomLink.href = '/chat/chatrooms/out?chatroomid='+ roomId + '&userId=' +userId1;
            console.log(exitChatRoomLink.href);
        }
                
        function loadMessages(roomId) {
            var URL = 'http://localhost:8081/chat/message/room/';
            $.ajax({
                url: URL + roomId,
                type: 'GET',
                success: function(data) {
                    showMessage(data);
                },
                error: function() {
                    alert('메시지를 불러오는데 실패했습니다.');
                }
            });
        }
        
        function loadChatRoomsBySearch(){
        	var id = document.getElementById('inlineFormInputGroup').value;
        	var URL = 'http://localhost:8081/chat/chatrooms/loadrooms/search/';
        	if(!id){
        		id = userId1;
        		URL = 'http://localhost:8081/chat/chatrooms/loadrooms/';
        	}
            $.ajax({
                url: URL + id,
                type: 'GET',
                success: function(response) {
                	loadChatRoomsView(response, userId1);
                },
                error: function() {
                    alert('검색된 채팅방 없습니다.');
                }
            });
        }
        
        

        function loadChatRoomsConnect(chatroomid, userId1){
            var URL = 'http://localhost:8081/chat/chatrooms/loadrooms/searchroom/';
            $.ajax({
            	url: URL + chatroomid + '/' + userId1,
                type: 'GET',
                success: function(response) {
                	loadChatRoomsConnectView(response, userId1);
                },
                error: function() {
                    alert('채팅방을 불러오는데 실패했습니다.');
                }
            });
        }
   
        
        function loadChatRoomsConnectView(chatRoom, userId1) {
        	var centerStyle = $('#centerstyle');
            centerStyle.empty();
            var chatRoomNames = '';
            var chatMembers = '';
            if (chatRoom.roomType !== 'PRIVATE') {
	           	if (chatRoom.chatRoomNames.length > 0) {
	                var name = chatRoom.chatRoomNames[0].roomName.replace(/_/g, ' ').trim();
	                chatMembers = name;
	                chatRoomNames = name;
	            }
	         } else {
			        chatRoomNames = chatRoom.chatRoomNames[0].roomName;
			        chatMembers = '개인방';
			    }
            var chatRoomList = `
                <a href="#" class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/user.png" alt="user img">
                        <span class="active"></span>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <input class="roomNameStyle" type="text" id="chatRoomNameInput" value="${chatRoomNames}">
                        <img class="img-chateditImg" src="/img/chat/chatedit.png" id="editRoomNameImg" onclick="editRoomName('${chatRoom.chatroomid}','${userId1}')">
                        <p>${chatMembers}</p>
                    </div>
                </a>
            `;
            centerStyle.append(chatRoomList);
        }
        
        function editRoomName(chatRoomId, userId1) {
        	var newRoomName = document.getElementById('chatRoomNameInput').value;
            if (newRoomName) {
                $.ajax({
                    url: '/chat/chatrooms/edit',
                    type: 'POST',
                    data: {
                    	userId1 : userId1,
                        chatroomid: chatRoomId,
                        newRoomName: newRoomName
                    },
                    success: function(response) {
                    	loadChatRooms(userId1);
                    },
                    error: function(error) {
                        alert('채팅방 이름 수정에 실패했습니다.');
                    }
                });
            }
        }
        
        function loadChatRooms(userId1) {
            var URL = 'http://localhost:8081/chat/chatrooms/loadrooms/';
            $.ajax({
                url: URL + userId1,
                type: 'GET',
                success: function(response) {
                	loadChatRoomsView(response, userId1);
                },
                error: function() {
                    alert('채팅방을 불러오는데 실패했습니다.');
                }
            });
        }

        function loadChatRoomsView(data, userId1) {
            var openStyle = $('#openstyle');
            var closeStyle = $('#closestyle');
            openStyle.empty();
            closeStyle.empty();
            data.forEach(function(chatRoom) {
 		       var chatRoomNames = '';
 	           var chatMembers = '';
 	           if (chatRoom.roomType !== 'PRIVATE') {
 	           		if (chatRoom.chatRoomNames.length > 0) {
 	                	 var name = chatRoom.chatRoomNames[0].roomName.replace(/_/g, ' ').trim();
 	                 	 chatMembers = name;
 	                 	 chatRoomNames = name;
 	             		}
 	         	} else {
 			            chatRoomNames = chatRoom.chatRoomNames[0].roomName;
 			            chatMembers = '개인방';
 			    }
 			    var chatRoomList = `
			         <a href="#" class="d-flex align-items-center">
			             <div class="flex-shrink-0">
			                 <img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/user.png" alt="user img">
			                 <span class="active"></span>
			             </div>
			             <div class="flex-grow-1 ms-3">
			                 <h3 onclick="connect('${chatRoom.chatroomid}')">${chatRoomNames}</h3>
			                 <p>${chatMembers}</p>
			             </div>
			         </a>
			      `;
 			    if (chatRoom.roomType === 'PERSONAL' || chatRoom.roomType === 'PRIVATE') {
			          openStyle.append(chatRoomList);
			        } else if (chatRoom.roomType === 'GROUP') {
			            closeStyle.append(chatRoomList);
			        }
			    });
			}
		
        function inviteUser(roomId) {
            var newuserId = document.getElementById('inviteUserId').value;
            var sender = document.getElementById('sender').value;
            var message = {
            		'type': 'INVITE',
                    'sender' : sender,
                    'content' : newuserId,
                    'newuserId' : newuserId,
                    'sendDate' : sendDay + ' ' + sendTime
                };  
                stompClient.send("/send/" + roomId, {}, JSON.stringify(message));
                document.getElementById('message').value = '';
        }

        function sendMessage(roomId) {
            const date = new Date();
            const yoptions = { 
            		  year: 'numeric', 
            		  month: 'long', 
            		  day: '2-digit'
            		};
            const hoptions = {
            		 hour: '2-digit', 
           		 	 minute: '2-digit',
           		 	 second: '2-digit',
           		  	 hour12: false 
            }
            const sendDay = date.toLocaleString('ko-KR', yoptions);
            const sendTime = date.toLocaleString('ko-KR', hoptions);
            
            var content = document.getElementById('message').value;
            var sender = document.getElementById('sender').value;
            var message = {
            	'type': 'MESSAGE',	
                'content' : content,
                'sender' : sender,
                'sendDate' : sendDay + ' ' + sendTime
            };  
            stompClient.send("/send/chat/message/" + roomId, {}, JSON.stringify(message));
            document.getElementById('message').value = '';
        }
        
        function sendFileMessage(roomId) {
            const date = new Date();
            const yoptions = { 
            		  year: 'numeric', 
            		  month: 'long', 
            		  day: '2-digit'
            		};
            const hoptions = {
            		 hour: '2-digit', 
           		 	 minute: '2-digit',
           		 	 second: '2-digit',
           		  	 hour12: false 
            }
            const sendDay = date.toLocaleString('ko-KR', yoptions);
            const sendTime = date.toLocaleString('ko-KR', hoptions);
            
        	var sender = document.getElementById('sender').value;
            var fileInput = document.getElementById('upload');
            var file = fileInput.files[0];
            var formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/chat/message/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    var message = {
                        'type': 'FILE',
                        'fileName': response.fileName,
                        'fileRoot': response.fileRoot, 
                        'sender': sender,
                        'sendDate': sendDay + ' ' + sendTime
                    };
                    stompClient.send("/send/chat/message/" + roomId, {}, JSON.stringify(message));
                },
                error: function() {
                    alert('파일 업로드에 실패했습니다.');
                }
            });

            fileInput.value = '';
        }

        function showMessage(messages) {
            const date = new Date();
            const yoptions = { 
            		  year: 'numeric', 
            		  month: 'long', 
            		  day: '2-digit'
            		};
            const hoptions = {
            		 hour: '2-digit', 
           		 	 minute: '2-digit',
           		 	 second: '2-digit',
           		  	 hour12: false 
            }
            const sendDay = date.toLocaleString('ko-KR', yoptions);
            const sendTime = date.toLocaleString('ko-KR', hoptions);
            
            var response = document.getElementById('chat-content');
            response.innerHTML = ""; 
            messages.sort(function(a, b) {
                return new Date(a.sendDate).getTime() - new Date(b.sendDate).getTime();
            });
            messages.forEach(function(message) {	
            	var span = document.createElement('span');
                span.className = 'time';
            	var li = document.createElement('li');
                var p = document.createElement('p');        
                if (message.sender === userId1) {
                    li.className = 'sender';
                } else {
                    li.className = 'reply';
                }
                
                if (message.type === 'INVITE' || message.type === 'MESSAGE') {
                    p.innerHTML = message.sender + "<br/>" + message.content;
                    span.textContent = message.sendDate.substring(13, 18);
                } else if (message.type === "FILE") {
                    var fileLink;
                    var fileType = message.fileName.split('.').pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(fileType)) {
                        
                        fileLink = '<img src="' + message.fileRoot + '" alt="' + message.fileName + '" style="width:200px; height:200px;">';
                        p.innerHTML = message.sender + "<br/>" + fileLink;
                        span.textContent = message.sendDate.substring(13, 18);
                    } else {
                        
                        fileLink = '<a href="' + message.fileRoot + '" download="' + message.fileName + '">' + message.fileName + '</a>';
                        p.innerHTML = message.sender + "<br/>" + fileLink;
                        span.textContent = message.sendDate.substring(13, 18);
                    }
                }
                li.appendChild(p);
                li.appendChild(span);
                response.appendChild(li);
            });
        }

        function searchChatRooms() {
            var user = document.getElementById('search').value;
            window.location.href = '/chat/chatrooms?user=' + user;
        }
        
        $(document).ready(function () {
        	loadChatRooms(userId1);
            $("#sendButton").click(function() { sendMessage(roomId); });
            $("#inviteButton").click(function() { inviteUser(roomId); });
            $("#searchButton").click(function() { searchChatRooms(); });
            $("#upLoadButton").click(function() { sendFileMessage(roomId); });          
        });
    </script>
<body>
<div th:replace="~{/common/header :: header}"></div>
<div th:replace="~{/common/leftnav :: leftNav}"></div>

  <div class="main_body">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="chat-area">
                        <div class="chatlist">
                            <div class="modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="chat-header">
                                        <div class="msg-search">
                                            <input type="text" class="form-control" id="inlineFormInputGroup" placeholder="참여자이름으로 검색" aria-label="search" onkeypress="if(event.keyCode == 13){loadChatRoomsBySearch(this)}">
                                            <a class="add" href="#"><img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/add.svg" alt="add"></a>
                                        </div>

                                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="Open-tab" data-bs-toggle="tab" data-bs-target="#Open" type="button" role="tab" aria-controls="Open" aria-selected="true">1:1</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="Closed-tab" data-bs-toggle="tab" data-bs-target="#Closed" type="button" role="tab" aria-controls="Closed" aria-selected="false">단체방</button>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="modal-body">
                                        <div class="chat-lists">
                                            <div class="tab-content" id="myTabContent">
                                                <div class="tab-pane fade show active" id="Open" role="tabpanel" aria-labelledby="Open-tab">
                                                    <div class="chat-list" id="openstyle">
                                                        <a href="#" class="d-flex align-items-center">
                                                            <div class="flex-shrink-0">
                                                            </div>
                                                            <div class="flex-grow-1 ms-3">                                                          
                                                                <h3></h3>
                                                                <p></p>
                                                            </div>
                                                        </a>
                                                    </div>       
                                                </div>
                                                <div class="tab-pane fade" id="Closed" role="tabpanel" aria-labelledby="Closed-tab">
                                                    <div class="chat-list" id="closestyle">
                                                        <a href="#" class="d-flex align-items-center">
                                                            <div class="flex-shrink-0">
                                                            </div>
                                                            <div class="flex-grow-1 ms-3">  
                                                                <h3></h3>
                                                                <p></p>
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>                                              
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chatbox">
                            <div class="modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="msg-head">
                                        <div class="row">
                                            <div class="col-8">
                                                <div class="d-flex align-items-center" id="centerstyle">
                                                    <span class="chat-icon"><img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/arroleftt.svg" alt="image title"></span>
                                                    <div class="flex-grow-1 ms-3">                                                  
                                                        <h3></h3>
                                                        <p></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <ul class="moreoption">
                                                    <li class="navbar nav-item dropdown">
                                                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fa fa-ellipsis-v" aria-hidden="true"></i></a>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item" href="#">채팅참여자</a></li>
                                                            <li>
                                                                <hr class="dropdown-divider">
                                                            </li>
                                                            <li>
                                                            	<a class="dropdown-item" href="" id="getOutRoom">채팅방 나가기</a>
                                                            </li>
                                                        </ul>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal-body chat-content"> 
                                        <div class="msg-body">
                                            <ul id="chat-content">
                                                <li class="sender">
                                                	<span class="senderName"></span>
                                                    <p></p>
                                                    <span class="time"></span>
                                                </li>
                                                <li class="reply">
                                                	<span class="replyName"></span>
                                                    <p></p>
                                                    <span class="time"></span>
                                                </li>                                          
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="send-box">
                                        <form action="">
                                            <textarea id="message" class="form-control" aria-label="message…" placeholder="Write message…" maxlength="1000"></textarea>
											<input type="hidden" id="sender" th:value="${userId1}">
                                            <button type="button" id="sendButton"><i class="fa fa-paper-plane" aria-hidden="true"></i>전송</button>
                                        </form>

                                        <div class="send-btns">
                                            <div class="attach">
                                                <div class="button-wrapper">
                                                    <span class="label">
                                                        <img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/upload.svg" alt="image title"> attached file 
                                                    </span>
                                                    <input type="file" name="upload" id="upload" class="upload-box" placeholder="Upload File" aria-label="Upload File">
                                                </div>
                                                  <button type="button" id="sendButton" onclick="sendFileMessage(roomId)">업로드</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
  </div>
</body>
</html>